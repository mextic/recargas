
> recargas-optimizado@2.0.0 start
> node index.js

üöÄ Iniciando Sistema de Recargas Optimizado v2.0
=================================================

üìä Conectando bases de datos...
   ‚úÖ GPS DB conectada
   ‚úÖ ELIoT DB conectada
   ‚úÖ Redis conectado
üíæ Inicializando sistema de persistencia...
üîí Inicializando gestor de locks...
üîß [LOCK_MANAGER] Proveedor configurado: REDIS
‚öôÔ∏è Inicializando procesadores...
2025-09-14 20:48:50.251 [[32minfo[39m] [gps] [processor_init] Processor inicializado con sistema de errores inteligente
2025-09-14 20:48:50.253 [[32minfo[39m] [voz] [processor_init] Processor inicializado con sistema de errores inteligente
2025-09-14 20:48:50.253 [[32minfo[39m] [ELIoT] [processor_init] Processor inicializado con sistema de errores inteligente
üîç Verificando estado anterior...
üìÖ Configurando tareas programadas...
   üîÑ GPS verificar√° cada 10 minutos (GPS_MINUTOS_SIN_REPORTAR=10)
   üìû VOZ verificar√° 2 veces al d√≠a: 1:00 AM y 4:00 AM
   üîÑ ELIoT verificar√° cada 10 minutos (ELIOT_MINUTOS_SIN_REPORTAR=10)
   ‚Ä¢ GPS: Cada 10 minutos
   ‚Ä¢ VOZ: 2 veces al d√≠a (1:00 AM y 4:00 AM)
   ‚Ä¢ ELIOT: Cada 10 minutos

üß™ TESTING: Ejecutando ELIoT inmediatamente...

‚úÖ Sistema inicializado correctamente


üîß Ejecutando proceso GPS inicial...

==================================================
üöÄ [2025-09-14 20:48:50] Iniciando proceso GPS - Mazatl√°n
==================================================
2025-09-14 20:48:50.284 [[32minfo[39m] [gps] [process_start] Iniciando proceso de recarga
2025-09-14 20:48:50.285 [[32minfo[39m] [ERROR_HANDLER_GPS] [smart_retry_start] [recharge_gps_6874_1757908130284] Iniciando operaci√≥n con reintentos inteligentes
üîê [LOCK] Intentando adquirir lock: recharge_gps
   ‚Ä¢ Lock ID: recharge_gps_6874_1757908130284
   ‚Ä¢ PID: 6874
   ‚Ä¢ Timeout: 3600s
   ‚Ä¢ Proveedor: REDIS
üßπ [CLEANUP] Limpiando locks expirados (proveedor: REDIS)...
üî¥ [REDIS] Intentando lock en Redis: lockRecharge:recharge_gps
‚úÖ [REDIS] Lock adquirido exitosamente
2025-09-14 20:48:50.522 [[32minfo[39m] [ERROR_HANDLER_GPS] [operation_success] [recharge_gps_6874_1757908130284] Operaci√≥n ejecutada exitosamente
2025-09-14 20:48:50.523 [[32minfo[39m] [gps] [lock_acquired] Lock adquirido exitosamente
2025-09-14 20:48:50.523 [[32minfo[39m] [gps] [check_recovery_queue] Verificando cola auxiliar para recovery
2025-09-14 20:48:50.523 [[32minfo[39m] [ERROR_HANDLER_GPS] [smart_retry_start] [stats_1757908130523] Iniciando operaci√≥n con reintentos inteligentes
2025-09-14 20:48:50.524 [[32minfo[39m] [ERROR_HANDLER_GPS] [operation_success] [stats_1757908130523] Operaci√≥n ejecutada exitosamente
2025-09-14 20:48:50.524 [[32minfo[39m] [ERROR_HANDLER_GPS] [smart_retry_start] [records_1757908130524] Iniciando operaci√≥n con reintentos inteligentes
2025-09-14 20:48:50.525 [[32minfo[39m] [gps] [get_records_query] Ejecutando consulta GPS
2025-09-14 20:48:50.525 [[32minfo[39m] [ERROR_HANDLER_GPS] [smart_retry_start] [gps_query_1757908130525] Iniciando operaci√≥n con reintentos inteligentes
2025-09-14 20:48:50.980 [[32minfo[39m] [ERROR_HANDLER_GPS] [operation_success] [gps_query_1757908130525] Operaci√≥n ejecutada exitosamente
2025-09-14 20:48:50.981 [[32minfo[39m] [gps] [get_records_result] Consulta GPS completada
2025-09-14 20:48:50.981 [[32minfo[39m] [ERROR_HANDLER_GPS] [operation_success] [records_1757908130524] Operaci√≥n ejecutada exitosamente
2025-09-14 20:48:50.981 [[32minfo[39m] [gps] [records_fetched] Registros obtenidos para procesamiento
2025-09-14 20:48:50.981 [[32minfo[39m] [ERROR_HANDLER_GPS] [smart_retry_start] [process_1757908130981] Iniciando operaci√≥n con reintentos inteligentes
2025-09-14 20:48:50.982 [[32minfo[39m] [gps] [process_records_start] Iniciando procesamiento de registros GPS
2025-09-14 20:48:50.982 [[32minfo[39m] [gps] [gps_statistics] Estad√≠sticas GPS detalladas
2025-09-14 20:48:50.982 [[32minfo[39m] [gps] [gps_algorithm_indicators] Indicadores de algoritmo GPS
2025-09-14 20:48:50.983 [[33mwarn[39m] [gps] [devices_expiring_today] Dispositivos con vencimiento pr√≥ximo pero reportando
üìä DISTRIBUCI√ìN POR D√çAS SIN REPORTAR (L√≠mite: 14 d√≠as):
   ‚Ä¢ 0 d√≠as (reportando hoy): 258 dispositivos (72.7%)
   ‚Ä¢ 1-2 d√≠as (10% - muy reciente): 81 dispositivos (22.8%)
   ‚Ä¢ 3-5 d√≠as (35% - reciente): 8 dispositivos (2.3%)
   ‚Ä¢ 6-10 d√≠as (70% - moderado): 5 dispositivos (1.4%)
   ‚Ä¢ 11-14 d√≠as (100% - l√≠mite cr√≠tico): 3 dispositivos (0.8%)
   ‚ÑπÔ∏è  Nota: Solo se muestran dispositivos ‚â§14 d√≠as (filtro SQL HAVING)
üí° RECOMENDACIONES DE OPTIMIZACI√ìN:
   ‚Ä¢ Con umbral 10min: 98 dispositivos (27.6%)
   ‚Ä¢ Con umbral 30min: 96 dispositivos (27.0%)
   ‚Ä¢ Con umbral 60min: 95 dispositivos (26.8%)
   ‚Ä¢ Umbral actual: 10min ‚Üí 1 dispositivos
‚úÖ SALUDABLE: Solo 0.3% necesita recarga (<5% indica sistema estable)
üïê CONTEXTO TEMPORAL:
   ‚Ä¢ Hora actual: 20:48 (Mazatl√°n)
   ‚Ä¢ Momento del d√≠a: Noche
üü¢ GPS: {prefix}[32m[0m‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë   0% | 0/1 | Obteniendo proveedores... | ETA: Completado2025-09-14 20:48:50.984 [[32minfo[39m] [ERROR_HANDLER_GPS] [smart_retry_start] [balance_check_1757908130984] Iniciando operaci√≥n con reintentos inteligentes
2025-09-14 20:48:50.984 [[32minfo[39m] [gps] [get_taecel_balance] Consultando saldo TAECEL
2025-09-14 20:48:51.486 [[32minfo[39m] [ERROR_HANDLER_GPS] [operation_success] [balance_check_1757908130984] Operaci√≥n ejecutada exitosamente
2025-09-14 20:48:51.487 [[32minfo[39m] [gps] [balance_result] Balance TAECEL obtenido: $95700
2025-09-14 20:48:51.488 [[32minfo[39m] [ERROR_HANDLER_GPS] [smart_retry_start] [balance_check_1757908131488] Iniciando operaci√≥n con reintentos inteligentes
2025-09-14 20:48:51.489 [[32minfo[39m] [gps] [get_mst_balance] Consultando saldo MST
2025-09-14 20:48:51.932 [[32minfo[39m] [ERROR_HANDLER_GPS] [operation_success] [balance_check_1757908131488] Operaci√≥n ejecutada exitosamente
2025-09-14 20:48:51.933 [[32minfo[39m] [gps] [balance_result] Balance MST obtenido: $1.62
   üèÜ Proveedor con m√°s saldo: TAECEL ($95700)
2025-09-14 20:48:51.933 [[32minfo[39m] [gps] [provider_selected] Proveedor GPS seleccionado
üü¢ GPS: {prefix}[32m[0m‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë   0% | 0/1 | Usando proveedor: TAECEL (Saldo: $95700) | ETA: Infinitys2025-09-14 20:48:51.934 [[32minfo[39m] [gps] [process_device] Procesando dispositivo GPS
2025-09-14 20:48:51.934 [[32minfo[39m] [ERROR_HANDLER_GPS] [smart_retry_start] [gps_8111795230_1757908131934] Iniciando operaci√≥n con reintentos inteligentes
   üîµ TAECEL: RequestTXN para SIM 8111795230, C√≥digo: TEL010
   üîµ TAECEL: StatusTXN para TransID 250900977897

==================================================
üöÄ [2025-09-14 20:48:53] Iniciando proceso ELIOT - Mazatl√°n
==================================================
2025-09-14 20:48:53.284 [[32minfo[39m] [ELIoT] [process_start] Iniciando proceso de recarga
2025-09-14 20:48:53.284 [[32minfo[39m] [ERROR_HANDLER_ELIOT] [smart_retry_start] [recharge_ELIoT_6874_1757908133283] Iniciando operaci√≥n con reintentos inteligentes
üîê [LOCK] Intentando adquirir lock: recharge_ELIoT
   ‚Ä¢ Lock ID: recharge_ELIoT_6874_1757908133283
   ‚Ä¢ PID: 6874
   ‚Ä¢ Timeout: 3600s
   ‚Ä¢ Proveedor: REDIS
üßπ [CLEANUP] Limpiando locks expirados (proveedor: REDIS)...
üî¥ [REDIS] Intentando lock en Redis: lockRecharge:recharge_ELIoT
‚úÖ [REDIS] Lock adquirido exitosamente
2025-09-14 20:48:53.544 [[32minfo[39m] [ERROR_HANDLER_ELIOT] [operation_success] [recharge_ELIoT_6874_1757908133283] Operaci√≥n ejecutada exitosamente
2025-09-14 20:48:53.545 [[32minfo[39m] [ELIoT] [lock_acquired] Lock adquirido exitosamente
2025-09-14 20:48:53.545 [[32minfo[39m] [ELIoT] [check_recovery_queue] Verificando cola auxiliar para recovery
2025-09-14 20:48:53.545 [[32minfo[39m] [ERROR_HANDLER_ELIOT] [smart_retry_start] [stats_1757908133545] Iniciando operaci√≥n con reintentos inteligentes
2025-09-14 20:48:53.545 [[32minfo[39m] [ERROR_HANDLER_ELIOT] [operation_success] [stats_1757908133545] Operaci√≥n ejecutada exitosamente
2025-09-14 20:48:53.545 [[32minfo[39m] [ERROR_HANDLER_ELIOT] [smart_retry_start] [records_1757908133545] Iniciando operaci√≥n con reintentos inteligentes
‚úÖ Conectado a MongoDB para m√©tricas
   ‚úÖ √çndice uuid_1_fecha_-1 ya existe.
   ‚úÖ √çndice fecha_-1 ya existe.
‚úÖ Verificaci√≥n de √≠ndices de m√©tricas completada correctamente
2025-09-14 20:48:53.843 [[32minfo[39m] [ELIoT] [get_eliot_records_query] Ejecutando consulta ELIoT
2025-09-14 20:48:53.843 [[32minfo[39m] [ERROR_HANDLER_ELIOT] [smart_retry_start] [eliot_query_1757908133843] Iniciando operaci√≥n con reintentos inteligentes
2025-09-14 20:48:53.935 [[32minfo[39m] [ERROR_HANDLER_ELIOT] [operation_success] [eliot_query_1757908133843] Operaci√≥n ejecutada exitosamente
2025-09-14 20:48:53.935 [[32minfo[39m] [ELIoT] [get_eliot_records_result] Consulta inicial ELIoT completada
2025-09-14 20:48:53.936 [[32minfo[39m] [ELIoT] [mongodb_metrics_filter_start] Iniciando filtrado por m√©tricas MongoDB
2025-09-14 20:48:53.936 [[32minfo[39m] [ELIoT] [mongodb_metrics_filter_completed] Filtrado por m√©tricas completado
2025-09-14 20:48:53.936 [[32minfo[39m] [ERROR_HANDLER_ELIOT] [operation_success] [records_1757908133545] Operaci√≥n ejecutada exitosamente
2025-09-14 20:48:53.936 [[32minfo[39m] [ELIoT] [records_fetched] Registros obtenidos para procesamiento
2025-09-14 20:48:53.936 [[32minfo[39m] [ELIoT] [process_completed] Proceso completado exitosamente
üîì [LOCK] Liberando lock: recharge_ELIoT (proveedor: REDIS)
üîì [REDIS] Lock liberado: recharge_ELIoT
2025-09-14 20:48:53.983 [[32minfo[39m] [ELIoT] [lock_released] Lock liberado exitosamente

‚úÖ Proceso ELIOT completado en 0.70s
üèÅ [2025-09-14 20:48:53] Proceso finalizado - Mazatl√°n
   ‚Ä¢ Procesados: 0
   ‚Ä¢ Exitosos: 0
   ‚Ä¢ Fallidos: 0
2025-09-14 20:48:54.301 [[32minfo[39m] [ERROR_HANDLER_GPS] [operation_success] [gps_8111795230_1757908131934] Operaci√≥n ejecutada exitosamente
2025-09-14 20:48:54.302 [[32minfo[39m] [ERROR_HANDLER_GPS] [smart_retry_start] [aux_queue_8111795230_1757908134302] Iniciando operaci√≥n con reintentos inteligentes
2025-09-14 20:48:54.305 [[32minfo[39m] [ERROR_HANDLER_GPS] [operation_success] [aux_queue_8111795230_1757908134302] Operaci√≥n ejecutada exitosamente
üü¢ GPS: {prefix}[32m‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà[0m 100% | 1/1 | ‚úÖ 8111795230 - OK | ETA: Completado
2025-09-14 20:48:54.305 [[32minfo[39m] [gps] [gps_recharge_success] GPS recargado exitosamente
2025-09-14 20:48:54.305 [[32minfo[39m] [gps] [progress_update] Progreso GPS
2025-09-14 20:48:54.305 [[32minfo[39m] [gps] [process_successful_recharges] Procesando recargas exitosas para inserci√≥n en BD
2025-09-14 20:48:54.305 [[32minfo[39m] [ERROR_HANDLER_GPS] [smart_retry_start] [current_cycle_1757908134305] Iniciando operaci√≥n con reintentos inteligentes
   üîÑ Insertando 1 recargas GPS del ciclo actual como LOTE...
   ‚úÖ LOTE GPS: 1 recargas insertadas en BD como un solo registro maestro
   üßπ 1 recargas GPS removidas de cola auxiliar
2025-09-14 20:48:54.551 [[32minfo[39m] [ERROR_HANDLER_GPS] [operation_success] [current_cycle_1757908134305] Operaci√≥n ejecutada exitosamente
2025-09-14 20:48:54.551 [[32minfo[39m] [gps] [db_insertion_completed] Inserci√≥n en BD completada
2025-09-14 20:48:54.551 [[32minfo[39m] [ERROR_HANDLER_GPS] [operation_success] [process_1757908130981] Operaci√≥n ejecutada exitosamente
2025-09-14 20:48:54.551 [[32minfo[39m] [gps] [process_completed] Proceso completado exitosamente
üîì [LOCK] Liberando lock: recharge_gps (proveedor: REDIS)
üîì [REDIS] Lock liberado: recharge_gps
2025-09-14 20:48:54.617 [[32minfo[39m] [gps] [lock_released] Lock liberado exitosamente

‚úÖ Proceso GPS completado en 4.33s
üèÅ [2025-09-14 20:48:54] Proceso finalizado - Mazatl√°n
   ‚Ä¢ Procesados: 1
   ‚Ä¢ Exitosos: 1
   ‚Ä¢ Fallidos: 0

==================================================
üöÄ [2025-09-14 20:50:00] Iniciando proceso ELIOT - Mazatl√°n
==================================================
2025-09-14 20:50:00.048 [[32minfo[39m] [ELIoT] [process_start] Iniciando proceso de recarga
2025-09-14 20:50:00.048 [[32minfo[39m] [ERROR_HANDLER_ELIOT] [smart_retry_start] [recharge_ELIoT_6874_1757908200047] Iniciando operaci√≥n con reintentos inteligentes
üîê [LOCK] Intentando adquirir lock: recharge_ELIoT
   ‚Ä¢ Lock ID: recharge_ELIoT_6874_1757908200047
   ‚Ä¢ PID: 6874
   ‚Ä¢ Timeout: 3600s
   ‚Ä¢ Proveedor: REDIS
üßπ [CLEANUP] Limpiando locks expirados (proveedor: REDIS)...

==================================================
üöÄ [2025-09-14 20:50:00] Iniciando proceso GPS - Mazatl√°n
==================================================
2025-09-14 20:50:00.057 [[32minfo[39m] [gps] [process_start] Iniciando proceso de recarga
2025-09-14 20:50:00.058 [[32minfo[39m] [ERROR_HANDLER_GPS] [smart_retry_start] [recharge_gps_6874_1757908200057] Iniciando operaci√≥n con reintentos inteligentes
üîê [LOCK] Intentando adquirir lock: recharge_gps
   ‚Ä¢ Lock ID: recharge_gps_6874_1757908200057
   ‚Ä¢ PID: 6874
   ‚Ä¢ Timeout: 3600s
   ‚Ä¢ Proveedor: REDIS
üßπ [CLEANUP] Limpiando locks expirados (proveedor: REDIS)...
üî¥ [REDIS] Intentando lock en Redis: lockRecharge:recharge_ELIoT
üî¥ [REDIS] Intentando lock en Redis: lockRecharge:recharge_gps
‚ùå [REDIS] Lock ya existe, no se pudo adquirir
   ‚Ä¢ PID propietario: 97897
   ‚Ä¢ Edad: 0 minutos
   ‚Ä¢ Expira: 2025-09-14 21:50:00 (America/Mazatlan)
‚ùå [REDIS] Lock ya existe, no se pudo adquirir
   ‚Ä¢ PID propietario: 97897
   ‚Ä¢ Edad: 0 minutos
   ‚Ä¢ Expira: 2025-09-14 21:50:00 (America/Mazatlan)
2025-09-14 20:50:00.673 [[32minfo[39m] [ERROR_HANDLER_ELIOT] [operation_success] [recharge_ELIoT_6874_1757908200047] Operaci√≥n ejecutada exitosamente
2025-09-14 20:50:00.673 [[32minfo[39m] [ERROR_HANDLER_GPS] [operation_success] [recharge_gps_6874_1757908200057] Operaci√≥n ejecutada exitosamente
2025-09-14 20:50:00.673 [[33mwarn[39m] [ELIoT] [lock_acquisition_failed] No se pudo adquirir lock distribuido
2025-09-14 20:50:00.674 [[33mwarn[39m] [gps] [lock_acquisition_failed] No se pudo adquirir lock distribuido

‚úÖ Proceso ELIOT completado en 0.63s
üèÅ [2025-09-14 20:50:00] Proceso finalizado - Mazatl√°n
   ‚Ä¢ Procesados: 0
   ‚Ä¢ Exitosos: 0
   ‚Ä¢ Fallidos: 0

‚úÖ Proceso GPS completado en 0.62s
üèÅ [2025-09-14 20:50:00] Proceso finalizado - Mazatl√°n
   ‚Ä¢ Procesados: 0
   ‚Ä¢ Exitosos: 0
   ‚Ä¢ Fallidos: 0

üõë Deteniendo sistema...
   ‚Ä¢ Schedule GPS cancelado
   ‚Ä¢ Schedule VOZ-1 cancelado
   ‚Ä¢ Schedule VOZ-2 cancelado
   ‚Ä¢ Schedule ELIOT cancelado
üîì Liberando todos los locks (proveedor: REDIS)...
üîì [REDIS] 0 locks limpiados
‚úÖ Sistema detenido correctamente
